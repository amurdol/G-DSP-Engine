% !TEX root = fase4_integration.tex
% ============================================================================
% G-DSP Engine --- Documentaci\'{o}n T\'{e}cnica: Fase 4
% Integraci\'{o}n Final y Visualizaci\'{o}n HDMI
% ============================================================================
% Compilar:  pdflatex fase4_integration.tex  (x2 para referencias)
% ============================================================================

\documentclass[a4paper,11pt,spanish]{article}

% ---------------------------------------------------------------------------
% Paquetes
% ---------------------------------------------------------------------------
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[spanish,es-tabla]{babel}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{booktabs}
\usepackage{array}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{siunitx}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{enumitem}
\usepackage{float}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning, calc, shapes.geometric, decorations.pathreplacing, fit}

\geometry{margin=2.5cm}

\sisetup{
    output-decimal-marker = {,},
    per-mode = symbol
}

% ---------------------------------------------------------------------------
% Configuraci\'{o}n de listings para SystemVerilog
% ---------------------------------------------------------------------------
\lstdefinelanguage{SystemVerilog}{
    morekeywords={module, endmodule, input, output, logic, signed, parameter,
                  int, always_ff, always_comb, posedge, negedge, if, else,
                  begin, end, for, case, endcase, function, automatic,
                  endfunction, localparam, assign, typedef, package,
                  endpackage, import, default, generate, endgenerate, wire},
    sensitive=true,
    morecomment=[l]{//},
    morecomment=[s]{/*}{*/},
    morestring=[b]",
}

\lstset{
    language=SystemVerilog,
    basicstyle=\ttfamily\footnotesize,
    keywordstyle=\bfseries\color{blue!70!black},
    commentstyle=\itshape\color{green!50!black},
    stringstyle=\color{red!60!black},
    numbers=left,
    numberstyle=\tiny\color{gray},
    numbersep=5pt,
    frame=single,
    breaklines=true,
    captionpos=b,
    tabsize=4,
    showstringspaces=false,
}

% ---------------------------------------------------------------------------
% Datos del documento
% ---------------------------------------------------------------------------
\title{%
    \textbf{G-DSP Engine} \\[0.5em]
    \Large Integraci\'{o}n Final y Visualizaci\'{o}n HDMI \\[0.3em]
    \large Fase~4 --- Documentaci\'{o}n T\'{e}cnica del TFG
}
\author{G-DSP Team}
\date{Febrero 2026}

% ============================================================================
\begin{document}
% ============================================================================

\maketitle
\tableofcontents
\newpage

% ============================================================================
\section{Introducci\'{o}n a la Fase de Integraci\'{o}n}
\label{sec:intro_integration}
% ============================================================================

La Fase~4 del proyecto G-DSP Engine completa la implementaci\'{o}n del
m\'{o}dem 16-QAM integrando todos los subsistemas desarrollados en las
fases anteriores sobre la FPGA Gowin GW1NR-LV9QN88PC6/I5 (Tang Nano~9K).
Esta fase abarca:

\begin{itemize}
    \item Instanciaci\'{o}n del m\'{o}dulo \texttt{gdsp\_top} que conecta
          TX $\to$ Canal $\to$ RX en una cadena completa.
    \item Generaci\'{o}n de m\'{u}ltiples dominios de reloj mediante el
          PLL integrado de Gowin.
    \item Renderizado en tiempo real de la constelaci\'{o}n IQ sobre
          salida HDMI a VGA \SI{640}{\times}\SI{480}{} @ \SI{60}{Hz}.
    \item Interfaz f\'{\i}sica con botones y LEDs para control interactivo
          del nivel de ruido.
\end{itemize}

El resultado es un demostrador funcional donde el usuario puede observar
c\'{o}mo la dispersi\'{o}n de la constelaci\'{o}n aumenta al incrementar
la magnitud del ruido AWGN, verificando visualmente el correcto
funcionamiento del lazo de sincronizaci\'{o}n Costas.


% ============================================================================
\section{Arquitectura del Top-Level}
\label{sec:top_architecture}
% ============================================================================

El m\'{o}dulo \texttt{gdsp\_top} act\'{u}a como punto de entrada del
dise\~{n}o sintetizable. La Figura~\ref{fig:gdsp_top_block} muestra su
diagrama de bloques simplificado.

\begin{figure}[H]
\centering
\begin{tikzpicture}[
    block/.style={draw, rectangle, minimum width=2.2cm, minimum height=1cm,
                  align=center, font=\footnotesize},
    pll/.style={draw, rectangle, rounded corners, minimum width=1.8cm,
                minimum height=1.2cm, fill=yellow!20, align=center, font=\footnotesize},
    arrow/.style={-{Stealth[length=2mm]}, thick},
    dbox/.style={draw, dashed, rounded corners, inner sep=8pt}
]
    % PLL
    \node[pll] (pll) at (0,0) {Gowin\\PLL};
    
    % Clocks out
    \draw[arrow] (pll.east) -- ++(0.8,0) node[right, font=\scriptsize] {clk\_dsp (27\,MHz)};
    \draw[arrow] (pll.east) ++(0,-0.3) -- ++(0.8,0) node[right, font=\scriptsize] {clk\_pixel (25.2\,MHz)};
    \draw[arrow] (pll.east) ++(0,-0.6) -- ++(0.8,0) node[right, font=\scriptsize] {clk\_serial (126\,MHz)};
    
    % Clock in
    \draw[arrow] (-2,0) node[left, font=\scriptsize] {clk\_27m} -- (pll.west);

    % DSP Domain
    \node[block, fill=blue!10] (tx) at (5, 1.5) {tx\_top};
    \node[block, fill=orange!10] (ch) at (7.5, 1.5) {channel\_top};
    \node[block, fill=green!10] (rx) at (10, 1.5) {rx\_top};
    
    \draw[arrow] (tx) -- (ch);
    \draw[arrow] (ch) -- (rx);
    
    % Domain box DSP
    \node[dbox, fit=(tx)(ch)(rx), label={[font=\scriptsize]above:{Dominio clk\_dsp}}] (dsp_domain) {};

    % Video Domain
    \node[block, fill=purple!10] (renderer) at (7.5, -1.5) {constellation\\renderer};
    \node[block, fill=red!10] (hdmi) at (10, -1.5) {hdmi\_tx};
    
    \draw[arrow] (renderer) -- (hdmi);
    
    % Domain box Video
    \node[dbox, fit=(renderer)(hdmi), label={[font=\scriptsize]above:{Dominio clk\_pixel}}] (vid_domain) {};
    
    % CDC
    \draw[arrow, dashed, blue] (rx.south) -- ++(0,-0.8) -| (renderer.north)
        node[pos=0.25, right, font=\scriptsize] {CDC};
    
    % HDMI out
    \draw[arrow] (hdmi.east) -- ++(1,0) node[right, font=\scriptsize] {TMDS};
    
    % Button/LED
    \node[block, fill=gray!10] (io) at (2.5, -1.5) {Debounce\\LEDs};
    \draw[arrow] (io.north) -- ++(0,0.8) -| (ch.south);
    \draw[arrow] (-2,-1.5) node[left, font=\scriptsize] {btn\_user} -- (io.west);
    \draw[arrow] (io.south) -- ++(0,-0.5) node[below, font=\scriptsize] {led[5:0]};

\end{tikzpicture}
\caption{Diagrama de bloques del m\'{o}dulo \texttt{gdsp\_top}.}
\label{fig:gdsp_top_block}
\end{figure}


% ============================================================================
\section{Gesti\'{o}n de Dominios de Reloj}
\label{sec:clock_domains}
% ============================================================================

El dise\~{n}o opera con tres relojes derivados del oscilador de
\SI{27}{MHz} de la placa Tang Nano~9K mediante un PLL Gowin:

\begin{table}[H]
\centering
\caption{Dominios de reloj del sistema.}
\label{tab:clocks}
\begin{tabular}{@{}llll@{}}
\toprule
\textbf{Se\~{n}al} & \textbf{Frecuencia} & \textbf{Per\'{\i}odo} & \textbf{Uso} \\
\midrule
\texttt{clk\_dsp}    & \SI{27}{MHz}     & \SI{37,04}{ns} & L\'{o}gica del m\'{o}dem (TX/RX/Canal) \\
\texttt{clk\_pixel}  & \SI{25,2}{MHz}   & \SI{39,68}{ns} & Pixel clock VGA 480p60 \\
\texttt{clk\_serial} & \SI{126}{MHz}    & \SI{7,94}{ns}  & Serializador TMDS 10:1 \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Cruce de Dominios (CDC)}

La transici\'{o}n de datos entre \texttt{clk\_dsp} y \texttt{clk\_pixel}
se realiza en el m\'{o}dulo \texttt{constellation\_renderer} mediante un
sincronizador de doble flip-flop para la se\~{n}al \texttt{sym\_valid}:

\begin{lstlisting}[caption={Sincronizador de 2-FF para CDC.}]
logic sym_valid_sync0, sym_valid_sync1, sym_valid_sync2;

always_ff @(posedge clk_pixel or negedge rst_n) begin
    if (!rst_n) begin
        sym_valid_sync0 <= 1'b0;
        sym_valid_sync1 <= 1'b0;
        sym_valid_sync2 <= 1'b0;
    end else begin
        sym_valid_sync0 <= sym_valid;
        sym_valid_sync1 <= sym_valid_sync0;
        sym_valid_sync2 <= sym_valid_sync1;
    end
end

wire sym_pulse = sym_valid_sync1 && !sym_valid_sync2;  // Rising edge
\end{lstlisting}

Las coordenadas I/Q se muestrean en el dominio lento (\SI{27}{MHz}) y son
estables durante m\'{u}ltiples ciclos de \texttt{clk\_pixel}, por lo que
se capturan directamente tras detectar el flanco sincronizado.


% ============================================================================
\section{Renderizador de Constelaci\'{o}n}
\label{sec:renderer}
% ============================================================================

El m\'{o}dulo \texttt{constellation\_renderer} convierte las muestras IQ
demoduladas en una imagen de v\'{ı}deo VGA \SI{640}{\times}\SI{480}{} a
\SI{60}{Hz}.

\subsection{Conversi\'{o}n de Coordenadas Q1.11 a P\'{ı}xel}

Los valores I y Q en formato Q1.11 (rango $[-2048, +2047]$) se escalan a
un \'{a}rea de dibujo de $256 \times 256$ p\'{ı}xeles centrada en la
pantalla:

\begin{align}
    x_{\text{pixel}} &= 320 + \left\lfloor \frac{I}{16} \right\rfloor
                      = 320 + (I \gg 4) \\
    y_{\text{pixel}} &= 240 - \left\lfloor \frac{Q}{16} \right\rfloor
                      = 240 - (Q \gg 4)
\end{align}

La divisi\'{o}n por 16 (desplazamiento de 4 bits) mapea el rango
$[-2048, +2047]$ a $[-128, +127]$ p\'{\i}xeles respecto al centro. El eje
Y se invierte porque las coordenadas de pantalla crecen hacia abajo.

\subsection{T\'{e}cnica de Dibujado de Puntos}

Sin memoria de \textit{frame buffer}, el renderizado es directo:

\begin{enumerate}
    \item Se almacenan las \'{u}ltimas 64 coordenadas de s\'{\i}mbolos
          recibidos en un buffer circular.
    \item Al inicio de cada cuadro (flanco de \texttt{vsync}), el buffer
          se invalida para simular decaimiento temporal.
    \item Durante el barrido activo, si la posici\'{o}n $(h, v)$ del
          p\'{\i}xel actual coincide con alguna coordenada almacenada
          $\pm 1$ (punto de $2 \times 2$ p\'{\i}xeles), se genera blanco;
          de lo contrario, negro.
\end{enumerate}

El resultado es una constelaci\'{o}n con persistencia de un cuadro
($\approx$\SI{16,7}{ms}), suficiente para visualizaci\'{o}n humana.

\subsection{Rejilla de Referencia}

Adem\'{a}s de los puntos de s\'{\i}mbolo, se dibujan l\'{\i}neas de
referencia (gris oscuro):

\begin{itemize}
    \item \textbf{Ejes}: l\'{\i}neas horizontal y vertical por el centro.
    \item \textbf{L\'{\i}mites de decisi\'{o}n}: l\'{\i}neas en
          $x, y = \pm 51$ p\'{\i}xeles (correspondientes a $\pm 816$ en
          Q1.11, punto medio entre niveles QAM adyacentes).
    \item \textbf{Borde del \'{a}rea de dibujo}: rect\'{a}ngulo
          $256 \times 256$.
\end{itemize}

\subsection{Correcci\'{o}n Anam\'{o}rfica para Pantallas 16:9}
\label{subsec:anamorphic}

\subsubsection{Problema: Distorsi\'{o}n por Escalado de Monitores}

Los monitores modernos operan nativamente en formato 16:9 (1920$\times$1080,
2560$\times$1440, etc.). Cuando se les alimenta una se\~{n}al VGA 
640$\times$480 (formato 4:3), el escalador autom\'{a}tico del monitor
estira la imagen para llenar toda la pantalla, aplicando factores de escala
diferentes en cada eje:

\begin{align}
    S_x &= \frac{1920}{640} = 3.00 \quad \text{(escalado horizontal)} \\
    S_y &= \frac{1080}{480} = 2.25 \quad \text{(escalado vertical)}
\end{align}

Esta diferencia ($S_x / S_y = 1.333 = 4/3$) distorsiona cualquier figura
circular (como una constelaci\'{o}n QAM te\'{o}rica) en un elipsoide
estirado horizontalmente.

\subsubsection{Soluci\'{o}n: Pre-compresi\'{o}n Computacional}

En lugar de intentar cambiar la resoluci\'{o}n de salida (lo cual estar\'{\i}a
limitado por las restricciones del PLL de la FPGA Gowin GW1NR-9, donde
ciertos divisores ODIV no est\'{a}n disponibles), aplicamos una
\textbf{correcci\'{o}n anam\'{o}rfica} directamente en el DSP de renderizado.

La t\'{e}cnica consiste en pre-comprimir el eje $X$ por un factor
$\alpha = S_y / S_x$ \textbf{antes} de dibujar la imagen:

\begin{equation}
    \alpha = \frac{S_y}{S_x} = \frac{2.25}{3.00} = 0.75 = \frac{3}{4}
\end{equation}

As\'{\i}, cuando el monitor posteriormente estira la imagen por
$S_x / S_y = 1.333$, la compensaci\'{o}n se cancela exactamente:

\begin{equation}
    \alpha \times \frac{S_x}{S_y} = 0.75 \times 1.333 = 1.00
    \quad \Rightarrow \text{C\'{\i}rculos perfectos}
\end{equation}

\subsubsection{Implementaci\'{o}n en Hardware}

En \texttt{constellation\_renderer.sv}, las coordenadas I/Q se convierten
a p\'{\i}xeles aplicando escalas diferentes:

\begin{align}
    x_{\text{pixel}} &= 320 + \left\lfloor \frac{I \times 3}{32} \right\rfloor
                      = 320 + \left( (I \times 3) \gg 5 \right) 
                      \label{eq:anamorphic_x} \\
    y_{\text{pixel}} &= 240 - \left\lfloor \frac{Q}{8} \right\rfloor
                      = 240 - (Q \gg 3)
                      \label{eq:anamorphic_y}
\end{align}

Observaciones:

\begin{itemize}
    \item La ecuaci\'{o}n (\ref{eq:anamorphic_x}) implementa un factor
          $3/32 \approx 0.094$ para el eje $X$. El factor base de 
          $1/8 = 0.125$ se multiplica por $3/4 = 0.75$ (anam\'{o}rfico)
          resultando en $0.125 \times 0.75 = 0.09375 \approx 3/32$.
    
    \item La ecuaci\'{o}n (\ref{eq:anamorphic_y}) usa el factor est\'{a}ndar
          $1/8$ sin correcci\'{o}n.
    
    \item El coste es 1 multiplicador de 13 bits y 1 shifter adicional
          (despreciable en recursos).
    
    \item La constelaci\'{o}n aparece ``comprimida'' en el framebuffer
          640$\times$480, pero se visualiza \textbf{perfectamente circular}
          en el monitor 16:9 tras el escalado autom\'{a}tico.
\end{itemize}

Esta t\'{e}cnica es com\'{u}n en producci\'{o}n cinematogr\'{a}fica
(formato anam\'{o}rfico CinemaScope) y se adapta aqu\'{\i} al dominio
digital sin coste adicional de hardware significativo.


% ============================================================================
\section{Transmisor HDMI (TMDS)}
\label{sec:hdmi_tx}
% ============================================================================

El m\'{o}dulo \texttt{hdmi\_tx} implementa la codificaci\'{o}n TMDS
(\textit{Transition-Minimized Differential Signaling}) requerida por el
est\'{a}ndar DVI/HDMI.

\subsection{Codificaci\'{o}n 8b/10b}

Cada canal de color (R, G, B) pasa por un codificador 8b/10b que:

\begin{enumerate}
    \item Calcula el n\'{u}mero de unos en el byte de entrada.
    \item Decide entre codificaci\'{o}n XOR o XNOR para minimizar
          transiciones.
    \item Aplica inversi\'{o}n condicional para mantener el balance DC
          ($\pm 0$ acumulado de unos y ceros).
\end{enumerate}

Durante el intervalo de \textit{blanking}, se transmiten s\'{\i}mbolos de
control que codifican \texttt{hsync} y \texttt{vsync}.

\subsection{Serializaci\'{o}n 10:1}

Los 10 bits TMDS se serializan a \SI{126}{MHz} usando un registro de
desplazamiento. LSB se transmite primero. En s\'{\i}ntesis para Gowin, se
emplear\'{\i}a el primitivo \texttt{OSER10} para eficiencia.

\subsection{Salida Diferencial}

Las se\~{n}ales serializadas se env\'{\i}an a pads configurados como
\texttt{LVCMOS33D}, que emulan LVDS con swing reducido. Los pines de
salida son:

\begin{table}[H]
\centering
\caption{Pinout HDMI en Tang Nano 9K.}
\label{tab:hdmi_pins}
\begin{tabular}{@{}llc@{}}
\toprule
\textbf{Se\~{n}al} & \textbf{Pin (P/N)} & \textbf{Funci\'{o}n} \\
\midrule
\texttt{tmds\_clk}    & 69 / 68 & Pixel clock codificado \\
\texttt{tmds\_data[0]} & 71 / 70 & Canal Azul (+ sync) \\
\texttt{tmds\_data[1]} & 73 / 72 & Canal Verde \\
\texttt{tmds\_data[2]} & 75 / 74 & Canal Rojo \\
\bottomrule
\end{tabular}
\end{table}


% ============================================================================
\section{Interfaz F\'{\i}sica: Botones y LEDs}
\label{sec:io}
% ============================================================================

\subsection{Control de Ruido mediante Bot\'{o}n S1}

El bot\'{o}n S1 (activo bajo, con pull-up interno) cicla el par\'{a}metro
\texttt{noise\_magnitude} entre cuatro niveles predefinidos:

\[
    0 \to 20 \to 50 \to 100 \to 0 \to \cdots
\]

Se implementa un antirrebote de \SI{20}{ms} mediante un contador de 19
bits:

\begin{lstlisting}[caption={L\'{o}gica de antirrebote.}]
logic [18:0] debounce_cnt;
always_ff @(posedge clk_dsp or negedge sys_rst_n) begin
    if (!sys_rst_n) begin
        debounce_cnt <= '0;
        btn_stable   <= 1'b1;
    end else begin
        if (btn_sync1 != btn_stable) begin
            if (debounce_cnt == 19'h7FFFF)
                btn_stable <= btn_sync1;
            else
                debounce_cnt <= debounce_cnt + 1'b1;
        end else begin
            debounce_cnt <= '0;
        end
    end
end
\end{lstlisting}

\subsection{Indicadores LED}

Los 6 LEDs de la placa (activos bajos) muestran:

\begin{table}[H]
\centering
\caption{Asignaci\'{o}n de LEDs.}
\label{tab:leds}
\begin{tabular}{@{}cl@{}}
\toprule
\textbf{LED} & \textbf{Funci\'{o}n} \\
\midrule
\texttt{led[0]} & Latido (\textit{heartbeat}), $\approx$\SI{0,8}{Hz} \\
\texttt{led[1]} & Lock del lazo Costas (encendido = sincronizado) \\
\texttt{led[3:2]} & Nivel de ruido en binario (00, 01, 10, 11) \\
\texttt{led[4]} & Lock del PLL (encendido = estable) \\
\texttt{led[5]} & Reservado (apagado) \\
\bottomrule
\end{tabular}
\end{table}


% ============================================================================
\section{Archivo de Restricciones de Pines}
\label{sec:constraints}
% ============================================================================

El archivo \texttt{constraints/tangnano9k.cst} define la asignaci\'{o}n
de pines para la placa Tang Nano 9K:

\begin{lstlisting}[language={}, caption={Extracto de tangnano9k.cst.}]
// Reloj 27 MHz
IO_LOC  "clk_27m" 52;
IO_PORT "clk_27m" IO_TYPE=LVCMOS33 PULL_MODE=NONE;

// Reset (boton S2)
IO_LOC  "rst_n" 4;
IO_PORT "rst_n" IO_TYPE=LVCMOS18 PULL_MODE=UP;

// Boton usuario S1
IO_LOC  "btn_user" 3;
IO_PORT "btn_user" IO_TYPE=LVCMOS18 PULL_MODE=UP;

// HDMI diferencial
IO_LOC  "tmds_clk_p" 69;
IO_LOC  "tmds_clk_n" 68;
IO_PORT "tmds_clk_p" IO_TYPE=LVCMOS33D DRIVE=8;
...
\end{lstlisting}

El archivo \texttt{constraints/timing.sdc} establece las restricciones
temporales para el an\'{a}lisis de \textit{timing closure}:

\begin{lstlisting}[language={}, caption={Extracto de timing.sdc.}]
create_clock -name clk_27m -period 37.037 [get_ports {clk_27m}]
create_clock -name clk_pixel -period 39.683 [get_pins {u_clkdiv/clkout}]
create_clock -name clk_serial -period 7.937 [get_pins {u_pll/clkout}]
set_clock_groups -asynchronous -group {clk_27m} -group {clk_pixel clk_serial}
set_false_path -from [get_ports {rst_n btn_user}]
\end{lstlisting}

Los per\'{\i}odos corresponden a:
\begin{itemize}
    \item \texttt{clk\_27m}: \SI{27}{MHz} $\to$ \SI{37,037}{ns}
    \item \texttt{clk\_pixel}: \SI{25,2}{MHz} $\to$ \SI{39,683}{ns}
    \item \texttt{clk\_serial}: \SI{126}{MHz} $\to$ \SI{7,937}{ns}
\end{itemize}


% ============================================================================
\section{Validaci\'{o}n del Sistema Integrado}
\label{sec:validation}
% ============================================================================

\subsection{Testbench de Integraci\'{o}n}

El testbench \texttt{tb\_gdsp\_top.sv} verifica:

\begin{enumerate}
    \item Compilaci\'{o}n sin errores de todos los m\'{o}dulos.
    \item El modelo de PLL genera clocks simulados.
    \item La cadena DSP produce s\'{\i}mbolos demodulados.
    \item El lazo Costas alcanza lock en un tiempo razonable.
    \item El bot\'{o}n cicla correctamente los niveles de ruido.
\end{enumerate}

\subsection{Resultados Esperados}

Con \texttt{noise\_magnitude = 0}, el sistema debe alcanzar lock en
aproximadamente 300--400 s\'{\i}mbolos (como en Fase~3). Al incrementar
el ruido, la constelaci\'{o}n visualizada mostrar\'{a} mayor dispersi\'{o}n,
pero el lock debe mantenerse hasta niveles de ruido moderados ($\leq 50$).


% ============================================================================
\section{Resumen de Recursos}
\label{sec:resources}
% ============================================================================

La Tabla~\ref{tab:resources} presenta una estimaci\'{o}n del uso de
recursos basada en s\'{\i}ntesis preliminar con Gowin EDA:

\begin{table}[H]
\centering
\caption{Estimaci\'{o}n de recursos del sistema completo (configuraci\'{o}n 480p).}
\label{tab:resources}
\begin{tabular}{@{}lrrr@{}}
\toprule
\textbf{Recurso} & \textbf{Usado} & \textbf{Disponible} & \textbf{\%} \\
\midrule
LUTs              & $\sim$5200  & 8640   & 60\% \\
Flip-Flops        & $\sim$2800  & 6480   & 43\% \\
DSP (MULT9)       & 8           & 20     & 40\% \\
BSRAM (18kb)      & 4           & 26     & 15\% \\
PLL               & 1           & 2      & 50\% \\
\bottomrule
\end{tabular}
\end{table}

\textbf{Nota}: Los valores son estimaciones. El uso real puede variar
seg\'{u}n opciones de optimizaci\'{o}n del sintetizador.


% ============================================================================
\section{Decisi\'{o}n de Dise\~{n}o: Optimizaci\'{o}n de Recursos y Selecci\'{o}n de Resoluci\'{o}n}
\label{sec:design_tradeoff}
% ============================================================================

\subsection{Restricciones del PLL: Por Qu\'{e} VGA 480p en Lugar de 720p}

Inicialmente se consider\'{o} implementar HD 720p (1280$\times$720@60Hz) para
aprovechar mejor el aspecto 16:9 de los monitores modernos. Sin embargo, la
arquitectura del PLL Gowin rPLL en la familia GW1NR-9 impone
\textbf{restricciones f\'{\i}sicas} en los divisores:

\begin{itemize}
    \item \textbf{Par\'{a}metro ODIV\_SEL}: Solo acepta los valores 
          $\{2, 4, 8, 16, 32, 64, 80, 128\}$. \textit{No admite 1}.
    \item \textbf{Par\'{a}metro CLKDIV}: Solo acepta los modos
          $\{2, 2.5, 3, 3.5, 4, 5, 8\}$. \textit{No admite 10}.
\end{itemize}

Para generar el pixel clock de 720p (\SI{74,25}{MHz}) desde una entrada
de \SI{27}{MHz}, se requerir\'{\i}a:

\begin{align}
    f_{\text{target}} &= 27 \times \frac{55}{2} = \SI{742,5}{MHz}
                        \quad \text{(VCO)} \\
    f_{\text{pixel}}  &= \frac{742,5}{10} = \SI{74,25}{MHz}
                        \quad \text{(requiere CLKDIV=10, \textbf{NO soportado})}
\end{align}

Rutas alternativas (como usar ODIV=1 con CLKDIV=5) tambi\'{e}n fallan
porque ODIV\_SEL=1 es inv\'{a}lido. El sintetizador Gowin reemplaza
autom\'{a}ticamente par\'{a}metros inv\'{a}lidos con valores por defecto
(ODIV=8), generando frecuencias incorrectas que causan colapso del sistema.

\textbf{Soluci\'{o}n adoptada}: VGA 480p (\SI{25,2}{MHz} pixel clock) es
perfectamente alcanzable:

\begin{align}
    f_{\text{VCO}} &= 27 \times \frac{14}{3} = \SI{126}{MHz} \\
    f_{\text{serial}} &= \frac{126}{1} = \SI{126}{MHz} 
                        \quad \text{(ODIV=4 v\'{a}lido)} \\
    f_{\text{pixel}} &= \frac{126}{5} = \SI{25,2}{MHz}
                       \quad \text{(CLKDIV=5 v\'{a}lido)}
\end{align}

Esta configuraci\'{o}n usa par\'{a}metros soportados (IDIV=2, FBDIV=13, ODIV=4,
CLKDIV=5) y es estable en hardware real.

\subsection{Compensaci\'{o}n: T\'{e}cnica Anam\'{o}rfica}

Dado que 480p (4:3) se distorsiona en monitores 16:9, se implement\'{o} una
\textbf{correcci\'{o}n anam\'{o}rfica} en el renderizador (ver
\S\ref{subsec:anamorphic}). Esta t\'{e}cnica pre-comprime el eje horizontal
por factor 0.75, haciendo que la constelaci\'{o}n se muestre perfectamente
circular tras el escalado autom\'{a}tico del monitor, \textbf{sin necesidad
de cambiar la resoluci\'{o}n}.

\subsection{Optimizaci\'{o}n del Filtro RRC}

Adicionalmente, el filtro RRC se redujo de 33 a \textbf{5~taps} para cumplir con el
presupuesto de recursos DSP disponibles (10 bloques MULT18 en GW1NR-9):

\begin{enumerate}
    \item \textbf{Reducci\'{o}n de resoluci\'{o}n de video}: De \SI{720}{p}
          a VGA \SI{480}{p}, reduciendo la frecuencia serial de
          \SI{742,5}{MHz} (inaccesible) a \SI{126}{MHz} (estable).
    \item \textbf{Reducci\'{o}n del filtro RRC}: De 33 a 5~taps,
          manteniendo la simetr\'{\i}a y el roll-off $\alpha = 0.25$.
\end{enumerate}

\subsubsection{Justificaci\'{o}n del Filtro de 5 Taps}

El filtro RRC de 5~taps representa el compromiso m\'{\i}nimo viable:

\begin{itemize}
    \item Cubre apenas 1~per\'{\i}odo de s\'{\i}mbolo
          (5 taps / 4 SPS $\approx$ 1.25 s\'{\i}mbolos).
    \item Mantiene simetr\'{\i}a par (Tipo~I), garantizando fase lineal.
    \item Introduce aproximadamente 20\% de ISI residual, gestionado
          mediante \emph{dead zones} en los lazos de sincronismo.
    \item Permite utilizar el 100\% de los 10 DSP slices para la cadena
          completa (TX RRC I/Q, RX matched I/Q, Gardner, Costas).
    \item Es suficiente para prop\'{o}sitos did\'{a}cticos del TFG.
\end{itemize}

Para aplicaciones de producci\'{o}n, se recomendar\'{\i}a un filtro
m\'{a}s largo (17--33 taps) sobre una FPGA de mayor capacidad
(ej.~GW2AR con $>$18k~LUTs y 28~DSP slices).


% ============================================================================
\section{Conclusiones de la Fase 4}
\label{sec:conclusions}
% ============================================================================

La Fase~4 completa el proyecto G-DSP Engine integrando todos los
subsistemas en un demostrador funcional sobre Tang Nano~9K:

\begin{itemize}
    \item \textbf{Cadena completa}: PRBS $\to$ QAM $\to$ RRC(TX) $\to$
          AWGN $\to$ RRC(RX) $\to$ Gardner $\to$ Costas $\to$ HDMI.
    \item \textbf{Visualizaci\'{o}n en tiempo real}: constelaci\'{o}n IQ
          renderizada a VGA \SI{480}{p}@\SI{60}{Hz} sin memoria externa.
    \item \textbf{Interacci\'{o}n f\'{\i}sica}: control de ruido por
          bot\'{o}n, indicadores LED de estado.
    \item \textbf{Gesti\'{o}n de m\'{u}ltiples relojes}: PLL con dos
          salidas + CLKDIV, CDC con doble FF.
    \item \textbf{Optimizaci\'{o}n de recursos}: 480p + 5~taps RRC para
          caber en los 10~DSP slices del GW1NR-9 (100\% utilizaci\'{o}n).
\end{itemize}

El sistema est\'{a} listo para demostraci\'{o}n pr\'{a}ctica, mostrando
visualmente el efecto del ruido sobre la constelaci\'{o}n 16-QAM y la
capacidad del receptor para mantener sincronizaci\'{o}n.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\textwidth]{../figures/constellation_rx_sim.png}
    \caption{Constelaci\'{o}n 16-QAM capturada en simulaci\'{o}n RTL del
             sistema completo. Los s\'{\i}mbolos demodulados muestran el
             ISI residual caracter\'{\i}stico del filtro de 5~taps, pero
             permanecen claramente separados en cuadrantes.}
    \label{fig:const_final}
\end{figure}


% ============================================================================
\section*{Referencias}
% ============================================================================

\begin{enumerate}[label={[\arabic*]}]
    \item DVI Specification, Revision 1.0, Digital Display Working Group, 1999.
    \item CEA-861-F, ``A DTV Profile for Uncompressed High Speed Digital
          Interfaces,'' Consumer Electronics Association, 2013.
    \item Sipeed Tang Nano 9K Schematic, v3.2.
    \item Gowin GW1NR-LV9 Device Datasheet, DS861, 2023.
    \item Gowin Primitives User Guide, UG289, 2023.
\end{enumerate}

% ============================================================================
\end{document}
% ============================================================================
